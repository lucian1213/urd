<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>작가의 말 - 루시안</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Noto Serif KR', serif; background:#000; color:#fff; padding:15px; min-height:100vh; overflow-x:hidden; }
    .container { max-width:600px; margin:0 auto; padding:30px 15px; animation:fadeIn 1.5s ease-in-out forwards; }
    .container.animation-done { animation:none; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }
    .title { font-size:1.6rem; font-weight:600; text-align:center; margin-bottom:2.5rem; color:#fff; letter-spacing:1px; }
    .content { font-size:1rem; font-weight:400; margin-bottom:2.5rem; text-align:justify; color:#e8e8e8; line-height:1.7; }
    .content p { margin-bottom:0.3rem; }
    .author-name { color:#ccc; font-weight:500; margin-bottom:0; }
    .section-break { margin-top:1.5rem; }
    .input-section { margin:2.5rem 0; background:rgba(20,20,20,0.8); padding:1.5rem; border-radius:12px; border:1px solid #333; transition:opacity .8s ease-out, background .3s ease, border-color .3s ease; }
    .input-group { margin-bottom:1.2rem; }
    .input-group label { display:block; font-size:.9rem; font-weight:500; margin-bottom:.6rem; color:#fff; }
    .input-group input { width:100%; padding:.8rem; background:#1a1a1a; border:2px solid #333; border-radius:6px; color:#fff; font-family:'Noto Serif KR', serif; font-size:14px; transition:border-color .3s ease; }
    .input-group input:focus { outline:none; border-color:#666; background:#222; }
    .input-group input::placeholder { color:#777; }
    .textarea-group { margin-bottom:1rem; }
    .textarea-group label { display:block; font-size:.9rem; font-weight:500; margin-bottom:.6rem; color:#fff; }
    .textarea-group textarea { width:100%; min-height:120px; padding:.8rem; background:#1a1a1a; border:2px solid #333; border-radius:6px; color:#fff; font-family:'Noto Serif KR', serif; font-size:14px; resize:vertical; line-height:1.5; transition:border-color .3s ease; }
    .textarea-group textarea:focus { outline:none; border-color:#666; background:#222; }
    .textarea-group textarea::placeholder { color:#777; }
    .small-text { font-size:.75rem; color:#999; text-align:center; margin-bottom:1.5rem; font-style:italic; }
    .final-button { display:block; width:100%; max-width:280px; margin:2.5rem auto 0; padding:1rem 1.5rem; background:linear-gradient(135deg,#2a2a2a 0%,#1a1a1a 100%); border:2px solid #444; color:#fff; font-family:'Noto Serif KR', serif; font-size:1rem; font-weight:500; border-radius:8px; cursor:pointer; transition:all .3s ease; text-decoration:none; text-align:center; }
    .final-button:hover { background:linear-gradient(135deg,#3a3a3a 0%,#2a2a2a 100%); border-color:#666; transform:translateY(-2px); box-shadow:0 5px 15px rgba(255,255,255,.1); }
    .final-button:active { transform:translateY(0); }
    .fade-out { opacity:0 !important; transition:opacity .8s ease; }
    .fade-out-fast { opacity:0 !important; transition:opacity .6s ease; }
    .typing-area { margin-top:2rem; text-align:center; font-family:'Noto Serif KR', serif; }
    .typing-text { font-size:1.3rem; color:#e8e8e8; font-weight:500; min-height:2rem; transition:color .3s ease; }
    .glitching { color:#ff4444 !important; animation:textGlitch .1s infinite; }
    @keyframes textGlitch { 0% { transform:translate(0); text-shadow:2px 0 #f00, -2px 0 #0f0; } 25% { transform:translate(-1px,1px); text-shadow:-2px 0 #f00, 2px 0 #0f0; } 50% { transform:translate(1px,-1px); text-shadow:2px 0 #00f, -2px 0 #f00; } 75% { transform:translate(-1px,-1px); text-shadow:-2px 0 #0f0, 2px 0 #00f; } 100% { transform:translate(1px,1px); text-shadow:2px 0 #f00, -2px 0 #0f0; } }
    .screen-shake { animation:screenShake .15s infinite; }
    @keyframes screenShake { 0% { transform:translate(0,0) rotate(0deg); } 25% { transform:translate(2px,2px) rotate(.5deg); } 50% { transform:translate(-1px,1px) rotate(-.5deg); } 75% { transform:translate(1px,-2px) rotate(.5deg); } 100% { transform:translate(-2px,-1px) rotate(-.5deg); } }
    .green-message { font-size:1.5rem; font-weight:600; color:#4CAF50; margin-top:2rem; line-height:1.6; text-align:center; }
    .first-char-only { color:#ff0; font-weight:bold; font-size:1.1em; text-shadow:0 0 5px #ff0; }
    .fade-out-text { transition:opacity 1s ease-out; }
    .fade-out-paragraph { transition:opacity 1s ease-out; opacity:0; }
    .final-message { font-size:1.6rem; font-weight:700; color:#4CAF50; letter-spacing:1px; text-shadow:0 0 12px #4CAF50; text-align:center; animation:finalGlow 2s ease-in-out infinite; }
    @keyframes finalGlow { 0%,100% { text-shadow:0 0 10px #4CAF50; transform:scale(1); } 50% { text-shadow:0 0 20px #4CAF50, 0 0 30px #4CAF50; transform:scale(1.05); } }
    .center-stage { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:999; background:transparent; animation:fadeIn .8s ease; padding:20px; flex-direction:column; }
    .cheer-display { text-align:center; opacity:0; transform:translateY(20px); transition:all 0.8s ease; margin-top:50px; }
    .cheer-display.show { opacity:1; transform:translateY(0); }
    .cheer-content { font-size:1.8rem; font-weight:600; margin-bottom:15px; line-height:1.4; color:#fff; }
    .cheer-author { font-size:1rem; color:rgba(255,255,255,0.7); font-style:italic; }
    .random-cheer { position:fixed; z-index:998; pointer-events:none; opacity:0; transform:scale(0.8); transition:all 0.5s ease; text-align:center; max-width:300px; padding:10px; }
    .random-cheer.show { opacity:1; transform:scale(1); }
    .random-cheer .r-content { font-size:1rem; font-weight:500; color:rgba(255,255,255,0.9); margin-bottom:5px; line-height:1.3; }
    .random-cheer .r-author { font-size:0.8rem; color:rgba(255,255,255,0.6); font-style:italic; }
    .completion-container { position:fixed; inset:0; background:#000; z-index:1000; overflow-y:auto; padding:20px; animation:fadeIn 1s ease; }
    .completion-content { text-align:left; max-width:600px; margin:0 auto; color:#fff; font-family:'Noto Serif KR', serif; line-height:1.6; padding-bottom:2rem; }
    .completion-text { font-size:0.75rem; margin-bottom:3rem; }
    .completion-text p { margin-bottom:0.5rem; }
    .card-input-section { text-align:center; margin-top:2rem; padding:2rem; background:rgba(20,20,20,0.8); border-radius:12px; border:1px solid #333; }
    .input-instruction { font-size:1rem; margin-bottom:1rem; color:#fff; font-weight:500; }
    .card-input-section input { width:200px; padding:0.8rem; background:#1a1a1a; border:2px solid #333; border-radius:6px; color:#fff; font-family:'Noto Serif KR', serif; font-size:14px; text-align:center; margin-bottom:1rem; }
    .card-input-section input:focus { outline:none; border-color:#666; background:#222; }
    .card-input-section button { display:block; margin:1rem auto 0; padding:0.8rem 2rem; background:linear-gradient(135deg,#2a2a2a 0%,#1a1a1a 100%); border:2px solid #444; color:#fff; font-family:'Noto Serif KR', serif; font-size:1rem; border-radius:8px; cursor:pointer; transition:all .3s ease; }
    .card-input-section button:hover { background:linear-gradient(135deg,#3a3a3a 0%,#2a2a2a 100%); border-color:#666; transform:translateY(-2px); }
    .correct-ending-container { position:fixed; inset:0; background:#000; z-index:1000; display:flex; align-items:center; justify-content:center; padding:20px; animation:fadeIn 1s ease; }
    .correct-ending-content { text-align:center; max-width:600px; color:#fff; font-family:'Noto Serif KR', serif; line-height:1.6; }
    .correct-ending-text { font-size:1.1rem; margin-bottom:3rem; }
    .correct-ending-text p { margin-bottom:1rem; }
    .epilogue-button-section { text-align:center; margin-top:2rem; }
    .epilogue-button-section button { padding:1rem 2.5rem; background:linear-gradient(135deg,#2a2a2a 0%,#1a1a1a 100%); border:2px solid #444; color:#fff; font-family:'Noto Serif KR', serif; font-size:1.1rem; border-radius:8px; cursor:pointer; transition:all .3s ease; }
    .epilogue-button-section button:hover { background:linear-gradient(135deg,#3a3a3a 0%,#2a2a2a 100%); border-color:#666; transform:translateY(-2px); }
    .epilogue-container { position:fixed; inset:0; background:#000; z-index:1000; overflow-y:auto; padding:20px; animation:fadeIn 1s ease; }
    .epilogue-content { text-align:left; max-width:700px; margin:0 auto; color:#fff; font-family:'Noto Serif KR', serif; line-height:1.7; padding-bottom:2rem; }
    .epilogue-text { font-size:0.95rem; }
    .epilogue-text p { margin-bottom:0.8rem; }
    .game-end-container { position:fixed; inset:0; background:#000; z-index:1000; display:flex; align-items:center; justify-content:center; padding:20px; }
    .game-end-content { text-align:center; animation:fadeIn 2s ease-in-out; }
    .end-message { color:#fff; }
    .end-main-text { font-size:1.4rem; font-weight:500; margin-bottom:2rem; color:#e8e8e8; line-height:1.6; }
    .end-thanks { font-size:1.1rem; font-weight:400; margin-bottom:3rem; color:#ccc; }
    .author-signature { margin-bottom:3rem; font-style:italic; color:#aaa; font-size:1rem; }
    .the-end { font-size:1.8rem; font-weight:600; color:#fff; letter-spacing:3px; margin-top:2rem; }
    @media (max-width:768px){ .content { font-size:.9rem !important; line-height:1.6 !important; } .title { font-size:1.4rem; } .container { padding:20px 10px; } .input-section { padding:1.2rem; margin:2rem 0; } .typing-text { font-size:1.1rem; } .green-message { font-size:1.3rem; } .end-main-text { font-size:1.2rem; } .end-thanks { font-size:1rem; } .cheer-content { font-size:1.4rem; } .cheer-author { font-size:0.9rem; } .epilogue-content { max-width:100%; } .epilogue-text { font-size:0.85rem; line-height:1.6; } }
    @media (max-width:480px){ .content { font-size:.85rem !important; line-height:1.5 !important; } .title { font-size:1.3rem; letter-spacing:.5px; } .input-section { padding:1rem; } .typing-text { font-size:1rem; } .green-message { font-size:1.2rem; } .cheer-content { font-size:1.2rem; } .cheer-author { font-size:0.8rem; } }
    ::-webkit-scrollbar { width:6px; } ::-webkit-scrollbar-track { background:#1a1a1a; } ::-webkit-scrollbar-thumb { background:#444; border-radius:3px; } ::-webkit-scrollbar-thumb:hover { background:#666; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">작가의 말</h1>
    <div class="content" id="contentArea"></div>
    <div class="input-section" id="inputSection">
      <div class="input-group">
        <label for="nickname">닉네임</label>
        <input type="text" id="nickname" placeholder="닉네임을 입력해주세요" maxlength="20">
      </div>
      <div class="textarea-group">
        <label for="message">응원글</label>
        <textarea id="message" placeholder="진심 어린 응원의 메시지를 남겨주세요..."></textarea>
      </div>
      <p class="small-text">(아직도 운명을 바꾸고 싶다면, 진심을 다해 응원글을 적어주세요.)</p>
    </div>
    <button class="final-button" id="finalButton">마지막 페이지</button>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp, getCountFromServer } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCLzzo1F4H7-d-LhrbxsDzULJG86r2vKZU",
      authDomain: "cheer-b2471.firebaseapp.com",
      projectId: "cheer-b2471",
      storageBucket: "cheer-b2471.firebasestorage.app",
      messagingSenderId: "403286093961",
      appId: "1:403286093961:web:8613cf197b75c1e3579658"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* ====== 기믹 데이터 ======
       각 줄의 첫 글자를 세로로 읽으면: 아 직 게 임 은 끝 나 지 않 았 어
       각 줄은 독립 단위 — 화면이 좁으면 줄 내부만 쪼개고, 첫 글자는 보존 */
    const gimmickLines = [
      { text: "아...안녕하세요. 작가 루시안입니다. 한분 한분", section: 0, authorName: true },
      { text: "직접 뵙고 인사드리고 싶지만 그럴 수 없어 아쉽습니다.", section: 0 },
      { text: "게임은 어떠셨나요? 만족할만한 결말이었나요? 각자의", section: 1 },
      { text: "임무는 어떻게 느껴지셨나요? 각자가", section: 1 },
      { text: "은밀하게 움직였어야 했을텐데 어떠셨는지 궁금합니다.", section: 1 },
      { text: "끝나고 나서 결말이 맘에 안드시는 분들도 있을거에요.", section: 2 },
      { text: "나였어도 그렇게 생각할거에요. 운명은 정해진거라니...", section: 2 },
      { text: "지금도 전 운명은 정해져 있다고 생각해요. 그렇지", section: 2 },
      { text: "않다면, 세상은 너무 불확실하니까요. 싫었던 순간, 좋", section: 2 },
      { text: "았던 순간 모두 당신의 운명이에요.", section: 2 },
      { text: "어떤 의미든 모든 순간이 소중했을 거라고 생각해요.", section: 2 },
    ];
    const lastParagraphText = "지금 이 시간에도 운명을 바꾸기 위해 노력하는 다른 이진욱, 김기태, 고윤정, 이태성이 있을거에요. 그들에게 진심 어린 응원을 남겨볼까요? 다른 이들에게 힘이 될지도...?";

    function buildContent() {
      const content = document.getElementById('contentArea');
      if (!content) return;
      content.innerHTML = '';
      const containerWidth = content.clientWidth;

      const measurer = document.createElement('span');
      const style = getComputedStyle(content);
      measurer.style.cssText = 'position:absolute;visibility:hidden;white-space:nowrap;font-family:' + style.fontFamily + ';font-size:' + style.fontSize + ';font-weight:' + style.fontWeight + ';letter-spacing:' + style.letterSpacing + ';';
      document.body.appendChild(measurer);

      function measure(text) { measurer.textContent = text; return measurer.offsetWidth; }

      function wrapLine(text, maxW) {
        if (measure(text) <= maxW) return [text];
        const chars = [...text];
        const lines = [];
        let current = '';
        for (let i = 0; i < chars.length; i++) {
          const test = current + chars[i];
          if (measure(test) > maxW && current.length > 0) {
            lines.push(current);
            current = chars[i];
          } else {
            current = test;
          }
        }
        if (current.length > 0) lines.push(current);
        return lines;
      }

      let prevSection = -1;

      gimmickLines.forEach((lineData) => {
        const subLines = wrapLine(lineData.text, containerWidth);

        subLines.forEach((sub, subIdx) => {
          const p = document.createElement('p');
          p.textContent = sub;

          // 첫 번째 서브라인만 기믹 (첫 글자가 세로 메시지의 일부)
          if (subIdx === 0) p.dataset.gimmick = 'true';

          if (lineData.authorName && subIdx === 0) p.classList.add('author-name');

          if (lineData.section !== prevSection && subIdx === 0) {
            if (prevSection !== -1) p.classList.add('section-break');
            prevSection = lineData.section;
          }

          content.appendChild(p);
        });
      });

      // 마지막 문단
      const lastP = document.createElement('p');
      lastP.className = 'section-break last-paragraph';
      lastP.textContent = lastParagraphText;
      content.appendChild(lastP);

      measurer.remove();
    }

    // ====== Firebase DB ======
    class CheerMessageDB {
      constructor() { this.collectionName = 'cheerMessages'; }
      async saveMessage(nickname, message) {
        const newMessage = { nickname: nickname.trim() || '익명', message: message.trim(), timestamp: serverTimestamp(), createdAt: new Date().toISOString() };
        const docRef = await addDoc(collection(db, this.collectionName), newMessage);
        return { id: docRef.id, ...newMessage };
      }
      async getRecentMessages(count = 4) {
        const qy = query(collection(db, this.collectionName), orderBy('createdAt', 'desc'), limit(count));
        const snap = await getDocs(qy);
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }
      async getAllMessages() {
        const qy = query(collection(db, this.collectionName), orderBy('createdAt', 'desc'));
        const snap = await getDocs(qy);
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }
      async countAll() {
        const snap = await getCountFromServer(collection(db, this.collectionName));
        return snap.data().count || 0;
      }
      async seedSamples(samples) {
        for (const [nick, msg] of samples) { await this.saveMessage(nick, msg); await new Promise(r => setTimeout(r, 60)); }
      }
    }

    const cheerDB = new CheerMessageDB();

    function isEncouragementMessage(text) {
      const kw = ['힘내','화이팅','응원','파이팅','굿럭','좋은','멋진','대단한','최고','잘할','할 수 있','해낼','성공','이겨','극복','버텨','포기하지','끝까지','노력','희망','믿어','꿈','목표','도전','용기','자신감','열정','긍정','밝은'];
      return kw.some(k => text.includes(k)) || text.length > 10;
    }

    // ====== 메인 흐름 ======
    async function goToFinalPage() {
      const nickname = document.getElementById('nickname').value.trim();
      const message  = document.getElementById('message').value.trim();
      if (!nickname) { alert('닉네임을 입력해주세요.'); document.getElementById('nickname').focus(); return; }
      if (!message)  { alert('응원글을 작성해주세요.'); document.getElementById('message').focus(); return; }
      const isEnc = isEncouragementMessage(message);
      try {
        if (isEnc) {
          const saveP = cheerDB.saveMessage(nickname, message);
          const tout = new Promise((_, rej) => setTimeout(() => rej(new Error('timeout')), 5000));
          await Promise.race([saveP, tout]).catch(() => {});
          startEncouragementSequence();
        } else { showGameEndPage(); }
      } catch (err) { console.error('오류:', err); isEnc ? startEncouragementSequence() : showGameEndPage(); }
    }

    function showGameEndPage() {
      document.querySelector('.completion-container')?.remove();
      document.querySelector('.correct-ending-container')?.remove();
      document.querySelector('.epilogue-container')?.remove();
      document.querySelector('.container').style.display = 'none';
      document.body.insertAdjacentHTML('beforeend', '<div class="game-end-container"><div class="game-end-content"><div class="end-message"><p class="end-main-text">아쉽게도 게임은 여기까지입니다.</p><p class="end-thanks">즐겨주셔서 감사드립니다!</p><div class="author-signature"><p>-작가 루시안 드림-</p></div><div class="the-end"><p>THE END.</p></div></div></div></div>');
    }

    function startEncouragementSequence() {
      const container = document.querySelector('.container');
      container.classList.add('animation-done');
      const inputSection = document.getElementById('inputSection');
      const finalButton  = document.getElementById('finalButton');
      inputSection.classList.add('fade-out');
      finalButton.classList.add('fade-out');
      setTimeout(() => {
        finalButton.style.display = 'none';
        inputSection.classList.remove('fade-out');
        inputSection.style.opacity = '1';
        inputSection.style.background = 'transparent';
        inputSection.style.borderColor = 'transparent';
        inputSection.innerHTML = '<div class="typing-area"><div class="typing-text" id="typingText"></div></div>';
        startTypingAnimation();
      }, 800);
    }

    function startTypingAnimation() {
      const el = document.getElementById('typingText');
      const text = "아쉽게도 게임은 여기까지";
      let i = 0;
      const t = setInterval(() => { el.textContent = text.slice(0, i + 1); i++; if (i >= text.length) { clearInterval(t); setTimeout(startGlitchPhase, 1000); } }, 100);
    }

    function startGlitchPhase() {
      const el = document.getElementById('typingText');
      const container = document.querySelector('.container');
      el.classList.add('glitching'); container.classList.add('screen-shake');
      setTimeout(() => { el.classList.remove('glitching'); container.classList.remove('screen-shake'); el.style.display = 'none'; startGreenMessage(); }, 3000);
    }

    function startGreenMessage() {
      document.getElementById('inputSection').querySelector('.typing-area').insertAdjacentHTML('beforeend','<div class="green-message" id="greenMessage"></div>');
      const el = document.getElementById('greenMessage');
      const text = "아직 포기 하지마. 운명은 바꿀 수 있어.";
      let i = 0;
      const t = setInterval(() => { el.textContent = text.slice(0, i + 1); i++; if (i >= text.length) { clearInterval(t); setTimeout(startCharacterExtraction, 800); } }, 80);
    }

    function startCharacterExtraction() {
      const allP = document.querySelectorAll('.content p');
      const lastP = document.querySelector('.last-paragraph');
      if (lastP) lastP.classList.add('fade-out-paragraph');

      let idx = 0;
      const step = setInterval(() => {
        if (idx < allP.length) {
          const p = allP[idx];
          const isGimmick = p.dataset.gimmick === 'true';
          const text = p.textContent || '';
          if (isGimmick) {
            p.innerHTML = '<span class="first-char-only">' + text.charAt(0) + '</span><span class="fade-out-text">' + text.slice(1) + '</span>';
          } else {
            p.innerHTML = '<span class="fade-out-text">' + text + '</span>';
          }
          setTimeout(() => { const f = p.querySelector('.fade-out-text'); if (f) f.classList.add('fade-out'); }, 80);
          idx++;
        } else { clearInterval(step); setTimeout(fadeOutToBlankAndShowFinal, 900); }
      }, 480);
    }

    function fadeOutToBlankAndShowFinal() {
      document.querySelectorAll('.first-char-only').forEach(el => el.classList.add('fade-out-fast'));
      const green = document.getElementById('greenMessage');
      if (green) green.classList.add('fade-out-fast');
      setTimeout(() => {
        const title = document.querySelector('.title');
        const content = document.querySelector('.content');
        const inputSection = document.getElementById('inputSection');
        if (title) { title.classList.add('fade-out-fast'); setTimeout(()=> title.style.display='none', 600); }
        if (content){ content.classList.add('fade-out-fast'); setTimeout(()=> content.style.display='none',600); }
        if (inputSection){ inputSection.classList.add('fade-out-fast'); setTimeout(()=> inputSection.style.display='none',600); }
        setTimeout(() => {
          const center = document.createElement('div');
          center.className = 'center-stage';
          center.innerHTML = '<div class="final-message">아직 게임은 끝나지 않았어.</div>';
          document.body.appendChild(center);
          setTimeout(() => { showCheerMessages(center); }, 2000);
        }, 650);
      }, 620);
    }

    async function showCheerMessages(centerElement) {
      let msgs = [];
      try { msgs = await cheerDB.getRecentMessages(4); } catch (e) { console.warn('응원글 불러오기 실패:', e); }
      const finalMsg = centerElement.querySelector('.final-message');
      if (!msgs || msgs.length === 0) {
        if (finalMsg) { finalMsg.style.opacity = '0'; setTimeout(() => { finalMsg.innerHTML = '첫 번째 응원 메시지를 남겨주세요!'; finalMsg.style.opacity = '1'; }, 500); }
        setTimeout(() => showCompletionMessage(), 3000);
        return;
      }
      if (finalMsg) finalMsg.style.opacity = '0';
      setTimeout(() => { if (finalMsg) finalMsg.remove(); showMessagesSequentially(centerElement, msgs, 0); }, 500);
    }

    function showMessagesSequentially(container, messages, index) {
      if (index >= messages.length) {
        setTimeout(() => {
          const last = container.querySelector('.cheer-display');
          if (last) { last.classList.remove('show'); setTimeout(() => { last.remove(); startRandomCheerAnimation(messages); }, 800); }
          else startRandomCheerAnimation(messages);
        }, 2000);
        return;
      }
      const data = messages[index] || {};
      const text = (data.message || '').toString();
      const nick = (data.nickname || '익명').toString();
      const existing = container.querySelector('.cheer-display');
      if (existing) { existing.classList.remove('show'); setTimeout(() => { existing.remove(); create(); }, 800); }
      else create();

      function create() {
        const d = document.createElement('div');
        d.className = 'cheer-display';
        d.innerHTML = '<div class="cheer-content">"' + text + '"</div><div class="cheer-author">- ' + nick + ' -</div>';
        container.appendChild(d);
        setTimeout(() => d.classList.add('show'), 100);
        setTimeout(() => showMessagesSequentially(container, messages, index + 1), 2000);
      }
    }

    async function startRandomCheerAnimation(displayed) {
      try {
        const all = await cheerDB.getAllMessages();
        const ids = new Set(displayed.map(m => m.id));
        const rem = all.filter(m => !ids.has(m.id));
        shuffleInPlace(rem);
        const show = rem.slice(0, Math.min(20, rem.length));
        if (show.length === 0) { showCompletionMessage(); return; }
        let i = 0;
        const iv = setInterval(() => { if (i >= show.length) { clearInterval(iv); setTimeout(showCompletionMessage, 3000); return; } showRandomCheer(show[i]); i++; }, 500);
      } catch (e) { console.error('랜덤 응원글 오류:', e); showCompletionMessage(); }
    }

    function showCompletionMessage() {
      const div = document.createElement('div');
      div.className = 'completion-container';
      div.innerHTML = '<div class="completion-content"><div class="completion-text"><p>알았어. 알았어. 그만 해도 좋아.</p><br><p>아까부터 누가 말하는거냐고? 음... 뭐라고 해야할까.<br>나로 말할 거 같으면... 인간들이 흔히 말하는 신이라는<br>존재 일수도 있고, 지금 너희의 이야기인 \'운명의 세여신\'의<br>여신일 수도 있고, \'작가\'라고 말하는 존재일수도 있어.</p><br><p>이 이야기는 나의 뜻대로 정해져 있어. 너희가 아무리<br>바꾸려고 한들, 바꿀 수 없다는 이야기야. 운명이란건<br>그런거야. 아무리 발버둥쳐도 바꿀 수 없는 것.</p><br><p>노력하면 뭐든지 되는 거 아니었냐고? 그런거...너희들이<br>만든 허상에 불과해. 될 사람은 노력하지 않아도 되고,<br>안될 사람은 아무리 노력해도 안되는 거, 그게 이 세상이야.</p><br><p>...너무 한거 아니냐고? 그래 맞아. 그래서 내가 지금 굳이 나타나지<br>않아도 되는데 나타난건, 그래서 너희와 이야기하고 있는 건<br>아마 너희, 그리고 다른 무한한 세계선의 수많은 다른 이진욱, 김기태, 고윤정, 이태성의<br>의지가 모였기 때문에, 기회를 주기 위해서야. 아마 이 이야기의 엔딩을 보고 그냥<br>끝냈던 사람들, 혹은 운명을 바꾸고자 하는 의지를 담아 진심어린 응원을 보내지<br>않았던 사람들은 아마 지금 나와 이야기하지 못하고 있을 거야.<br>그만큼 너희가 운명을 바꾸고자 하는 의지가 크다는 거겠지.</p><br><p>그런 너희에게 운명을 바꿀 마지막 기회를 줄게. 지금 너희가<br>가지고 있는 것, 그러니까 카드중에 하나를 이 이야기에서 없앨<br>기회를 줄게. 너희가 올바른 선택을 한다면, 원하는대로 운명을<br>바꿀 수 있을거야.</p><br><p>명심해. 기회는 한번 뿐이야. 잘 생각해서 판단하라구.</p></div><div class="card-input-section"><p class="input-instruction">카드 번호를 입력하세요.</p><input type="text" id="cardNumber" placeholder="카드 번호를 입력해주세요" maxlength="10" inputmode="numeric" autocomplete="off" autocapitalize="off"><button id="submitCard">확인</button></div></div>';
      document.body.appendChild(div);
      requestAnimationFrame(() => { window.scrollTo({ top: 0, left: 0, behavior: 'auto' }); div.scrollTop = 0; });
      div.querySelector('#submitCard').addEventListener('click', submitCardNumber);
      div.querySelector('#cardNumber').addEventListener('keydown', (e) => { if (e.key === 'Enter') submitCardNumber(); });
    }

    function submitCardNumber() {
      const v = (document.getElementById('cardNumber')?.value || '').trim();
      if (!v) { alert('카드 번호를 입력해주세요.'); return; }
      if (v === '10') showCorrectEnding();
      else { document.querySelector('.completion-container')?.remove(); showGameEndPage(); }
    }

    function showCorrectEnding() {
      document.querySelector('.completion-container')?.remove();
      const div = document.createElement('div');
      div.className = 'correct-ending-container';
      div.innerHTML = '<div class="correct-ending-content"><div class="correct-ending-text"><p>그걸로 괜찮은건가. 너희의 선택이 어떤 결과로 이어질까.</p><p>이제 나와의 대화는 여기서 끝이야. 부디 원하는 대로 결과가 이루어지길 바래.</p><p>그럼 안녕.</p></div><div class="epilogue-button-section"><button id="epilogueBtn">에필로그 보기</button></div></div>';
      document.body.appendChild(div);
      div.querySelector('#epilogueBtn').addEventListener('click', showEpilogue);
    }

    function showEpilogue() {
      document.querySelector('.correct-ending-container')?.remove();
      const div = document.createElement('div');
      div.className = 'epilogue-container';
      div.innerHTML = '<div class="epilogue-content"><div class="epilogue-text"><p>"안녕하십니까! 오늘부로 강력 3팀으로 전입을 명 받은 이유정입니다!"</p><p>모처럼 조용했던 강력 3팀이 갑자기 소란스러워진다. 자신의 자리에서 졸다가 깜짝 놀라 잠에서 깬 이진욱 형사는 짜증 섞인 말투로 말한다.</p><p>"아이씨, 깜짝이야. 누가 이렇게 시끄럽게 인사를…"</p><p>시끄러운 인사의 주인공에게 고개를 돌린 이진욱은 화를 내려다 순간 흠칫한다.</p><p>놀랍게도 과거 자신이 소중히 여겼던 동료의 모습이, 그녀에게 어렴풋이 보였기 때문이다.</p><p>"선배님! 말씀 많이 들었습니다! 강력 3팀의 불도저! 앞으로 선배님께 많이 배우겠습니다!"</p><p>"흠… 너 이름이 뭐라고?"</p><p>"이유정입니다! 잘 부탁드립니다!"</p><p>"아오 시끄러워. 앞으로 내 앞에선 목소리 낮춰. 알겠나?"</p><p>"네! 명심하겠습니다!"</p><p>보란 듯이 더욱더 힘차게 대답한 그녀는, 이진욱을 향해 웃어 보인다.</p><p>이진욱은 그런 그녀를 보며 떠올리고 싶지 않았던, 과거의 일들이 떠오른다.</p><p>죄책감 때문일까. 그녀에겐 왠지 모를 미안함이 느껴진다.</p><br><p style="text-align:center;">. . . . . .</p><br><p>"선배님! 또 주무십니까!"</p><p>깜짝 놀라 잠에서 깬 이진욱 형사는 어안이 벙벙한 듯 주변을 둘러본다.</p><p>목소리를 따라 고개를 돌려보니, 이유정 형사가 자신을 보며 웃고 있다.</p><p>"선배님! 뭐 안 좋은 꿈이라도 꾸셨나 봅니다. 하핫."</p><p>안 좋은 꿈이라… 잘 기억은 안 나지만 어딘가 멀리, 긴 시간 동안 다녀온 기분이다.</p><p>정신을 차리고 주변을 둘러보니, 강력 3팀 자신의 자리다. 그래, 매일 보던 그 익숙한 풍경. 하지만 왜 인지 모르게 낯설게 느껴진다.</p><p>"2022년 12월 13일, 오늘의 뉴스입니다."</p><p>TV에서 뉴스가 나오고 있다. 뭔가 중요한 날이었던 것 같은 기분이 든다.</p><p>하지만 그것에 대해 생각할수록 머리가 깨질 듯이 아파진다. 그때 옆에 있던 이유정 형사가 누군가에게 인사를 한다.</p><p>"서장님! 안녕하십니까!"</p><p>서장? 이유정이 인사를 한 방향으로 시선을 돌려보니, 낯익은 모습의 남자가 나에게 인사를 해온다.</p><p>"야, 진욱아. 서장이 왔으면 인사는 못할망정 반가운 척이라도 해야 하는 거 아니냐…?"</p><p>그렇다. 내 친구. 경찰서장이었지…지금까지 쭉 그래왔을 텐데. 이진욱 형사는 이 상황이 무언가 어색하고 낯설다. 그때 어딘가에서 들려오는 전화 벨 소리.</p><p>"진욱아, 전화 오잖아. 오늘 좀 이상하네… 잠이 덜 깼나?"</p><p>주머니에서 휴대폰을 꺼내 화면을 보니 \'아들\'이라는 이름으로부터 전화가 오고 있다.</p><p>아들? 나한테 아들이 있었나? 미심쩍은 기분으로 전화를 받는다.</p><p>"여보세요. 아빠! 오늘 무슨 날인지 알지? 일찍 들어오기로 했잖아!"</p><p>"… 오늘이 무슨 날 인데?"</p><p>"아빠.. 몇 번이나 얘기했는데. 또 잊어버렸어? 내 생일이잖아…기대한 내가 잘못이다!"</p><p>그러고는, 수화기 너머로 어떤 여성의 목소리가 들려온다.</p><p>"어휴, 엄마 바꿔줘 봐. 여보! 오늘은 일찍 들어와! 현장 바쁜 거 나도 겪어봐서 다 알지만, 오늘 같은 날은 그래도 일찍 와! 준비하고 기다리고 있을 테니까."</p><p>"고… 윤정…?"</p><p>"그래. 왜, 이제 마누라 이름까지 까먹었어? 여튼 빨리 와! 기태한테도 얘기했으니까 기태랑 같이 와. 끊는다!"</p><p>끊어진 전화를 보며, 이진욱 형사는 왠지 모를 안도감과 함께 기쁨의 감정이 솟구쳐 오른다.</p><p>마치, 그 두 사람이 방금 전까지는 없었던 사람인 것처럼 느껴진다. 그때 갑자기 한 남성이 강력 3팀의 문을 박차고 들어오며 소리친다.</p><p>"선배님들! 출동이요 출동! 살인사건이랍니다!"</p><p>박정우였다. 강력 3팀의 6개월 차 신입이자 막내. 역시나 그에게도 평소와는 다른 무언가가 느껴지는 이진욱 형사는, 그를 보며 멍하니 생각에 잠긴다.</p><p>"선배님. 준비 안 하세요? 출동이라잖아요!"</p><p>미동도 없이 그의 자리에 앉아있는 이진욱 형사를 보며, 이유정 형사가 소리친다.</p><p>"어.. 어. 그래 알았어."</p><p>그제야 정신을 차린 듯 서둘러 장비를 챙기는 이진욱 형사. 모두가 출동하고 텅 빈 강력 3팀에는 틀어 놓은 TV소리만이 그 공간을 채우고 있다.</p><p>"다음 뉴스입니다. 세계적으로 그 재능을 인정받고 있는 과학자 박지우 씨가, 중대발표를 한다고 합니다. 과학자였던 아버지의 뒤를 이어, JH연구소의 소장이 된 그는 세계를 깜짝 놀라게 할 만한 연구에 성공했다고 합니다. 오늘 15시에 예정되어 있는 기자회견은…"</p><br><p style="text-align:center;">. . . . . .</p><br><p style="text-align:center; font-size:1.2rem; font-weight:600;">THE END.</p><br><p style="text-align:center; color:#ccc;">작가 : 루시안</p><p style="text-align:center; color:#ccc;">디자이너 : 맵씨</p><p style="text-align:center; color:#ccc;">제작 : 미스터리게임즈</p></div></div>';
      document.body.appendChild(div);
    }

    function showRandomCheer(msg) {
      const d = document.createElement('div');
      d.className = 'random-cheer';
      d.style.left = (Math.random() * (window.innerWidth - 320) + 10) + 'px';
      d.style.top = (Math.random() * (window.innerHeight - 100) + 10) + 'px';
      d.innerHTML = '<div class="r-content">"' + msg.message + '"</div><div class="r-author">- ' + msg.nickname + ' -</div>';
      document.body.appendChild(d);
      setTimeout(() => d.classList.add('show'), 60);
      setTimeout(() => { d.classList.remove('show'); setTimeout(() => d.remove(), 450); }, 1500);
    }

    function shuffleInPlace(a) { for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }

    // ====== 초기화 ======
    window.addEventListener('load', async () => {
      await document.fonts.ready;
      buildContent();
      window.addEventListener('resize', () => buildContent());
      try {
        const MIN = 24;
        const cur = await cheerDB.countAll();
        if (cur < MIN) {
          const need = MIN - cur;
          const samples = [['응원단장','힘내세요! 항상 응원하고 있어요!'],['열정맨','포기하지 마세요! 끝까지 화이팅!'],['희망이','당신은 충분히 잘하고 있어요!'],['용기쌤','어려운 시기지만 반드시 극복할 거예요!'],['긍정왕','오늘도 좋은 하루 되세요!'],['드림캐처','꿈을 향해 달려가세요!'],['파워업','당신의 잠재력을 믿어요!'],['선샤인','밝은 미래가 기다리고 있어요!'],['스트롱','어떤 어려움도 이겨낼 수 있어요!'],['해피','행복한 순간들이 가득하길!'],['브레이브','용감하게 도전하세요!'],['스마일','웃음 잃지 마세요!'],['위너','당신은 이미 승리자예요!'],['에너지','긍정 에너지 가득 보내드려요!'],['별빛','어둠 속에서도 빛나는 별처럼!'],['바람','순풍이 불어주길 바라요!'],['무지개','비 온 뒤 무지개가 뜰 거예요!'],['나침반','올바른 길로 인도해드릴게요!'],['봄날','따뜻한 봄날이 올 거예요!'],['날개','높이 날아오르세요!'],['등대','길을 잃지 않도록 응원해요!'],['보석','당신은 소중한 보석 같은 존재!'],['태양','밝게 빛나는 태양처럼!'],['달빛','고요한 밤에도 빛을 잃지 마세요!'],['하트','진심 어린 마음으로 응원합니다!']];
          await cheerDB.seedSamples(samples.slice(0, need));
          console.log('[seed] 샘플 ' + need + '개 주입 완료');
        }
      } catch (e) { console.warn('[seed] 실패:', e); }
      document.getElementById('nickname')?.focus();
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('finalButton')?.addEventListener('click', goToFinalPage);
      document.getElementById('nickname')?.addEventListener('keypress', e => { if (e.key === 'Enter') document.getElementById('message')?.focus(); });
    });
  </script>
</body>
</html>
