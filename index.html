<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>작가의 말 - 루시안</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body { font-family:'Noto Serif KR', serif; background:#000; color:#fff; padding:15px; min-height:100vh; overflow-x:hidden; }

    .container { max-width:600px; margin:0 auto; padding:30px 15px; animation:fadeIn 1.5s ease-in-out forwards; }
    .container.animation-done { animation:none; }

    @keyframes fadeIn { from { opacity:0; transform:translateY(30px); } to { opacity:1; transform:translateY(0); } }

    .title { font-size:1.6rem; font-weight:600; text-align:center; margin-bottom:2.5rem; color:#fff; letter-spacing:1px; }

    .content { font-size:1rem; font-weight:400; margin-bottom:2.5rem; text-align:justify; color:#e8e8e8; line-height:1.7; }
    .content p { margin-bottom:0.3rem; }

    .author-name { color:#ccc; font-weight:500; margin-bottom:0; }
    .section-break { margin-top:1.5rem; }

    .input-section { margin:2.5rem 0; background:rgba(20,20,20,0.8); padding:1.5rem; border-radius:12px; border:1px solid #333; transition:opacity .8s ease-out, background .3s ease, border-color .3s ease; }

    .input-group { margin-bottom:1.2rem; }
    .input-group label { display:block; font-size:.9rem; font-weight:500; margin-bottom:.6rem; color:#fff; }
    .input-group input { width:100%; padding:.8rem; background:#1a1a1a; border:2px solid #333; border-radius:6px; color:#fff; font-size:14px; transition:border-color .3s ease; }
    .input-group input:focus { outline:none; border-color:#666; background:#222; }
    .input-group input::placeholder { color:#777; }

    .textarea-group { margin-bottom:1rem; }
    .textarea-group label { display:block; font-size:.9rem; font-weight:500; margin-bottom:.6rem; color:#fff; }
    .textarea-group textarea { width:100%; min-height:120px; padding:.8rem; background:#1a1a1a; border:2px solid #333; border-radius:6px; color:#fff; font-size:14px; resize:vertical; line-height:1.5; transition:border-color .3s ease; }
    .textarea-group textarea:focus { outline:none; border-color:#666; background:#222; }
    .textarea-group textarea::placeholder { color:#777; }

    .small-text { font-size:.75rem; color:#999; text-align:center; margin-bottom:1.5rem; font-style:italic; }

    .final-button { display:block; width:100%; max-width:280px; margin:2.5rem auto 0; padding:1rem 1.5rem; background:linear-gradient(135deg,#2a2a2a 0%,#1a1a1a 100%); border:2px solid #444; color:#fff; font-size:1rem; font-weight:500; border-radius:8px; cursor:pointer; transition:all .3s ease; text-align:center; }
    .final-button:hover { background:linear-gradient(135deg,#3a3a3a 0%,#2a2a2a 100%); border-color:#666; transform:translateY(-2px); box-shadow:0 5px 15px rgba(255,255,255,.1); }
    .final-button:active { transform:translateY(0); }

    /* 연출 공용 */
    .fade-out { opacity:0 !important; transition:opacity .8s ease; }
    .fade-out-fast { opacity:0 !important; transition:opacity .6s ease; }

    .typing-area { margin-top:2rem; text-align:center; }
    .typing-text { font-size:1.3rem; color:#e8e8e8; font-weight:500; min-height:2rem; transition:color .3s ease; }

    .glitching { color:#ff4444 !important; animation:textGlitch .1s infinite; }
    @keyframes textGlitch {
      0% { transform:translate(0); text-shadow:2px 0 #f00,-2px 0 #0f0; }
      25% { transform:translate(-1px,1px); text-shadow:-2px 0 #f00,2px 0 #0f0; }
      50% { transform:translate(1px,-1px); text-shadow:2px 0 #00f,-2px 0 #f00; }
      75% { transform:translate(-1px,-1px); text-shadow:-2px 0 #0f0,2px 0 #00f; }
      100% { transform:translate(1px,1px); text-shadow:2px 0 #f00,-2px 0 #0f0; }
    }

    .screen-shake { animation:screenShake .15s infinite; }
    @keyframes screenShake {
      0% { transform:translate(0,0) rotate(0deg); }
      25% { transform:translate(2px,2px) rotate(.5deg); }
      50% { transform:translate(-1px,1px) rotate(-.5deg); }
      75% { transform:translate(1px,-2px) rotate(.5deg); }
      100% { transform:translate(-2px,-1px) rotate(-.5deg); }
    }

    .green-message { font-size:1.5rem; font-weight:600; color:#4CAF50; margin-top:2rem; line-height:1.6; text-align:center; }

    .first-char-only { color:#ff0; font-weight:bold; font-size:1.1em; text-shadow:0 0 5px #ff0; }
    .fade-out-text { transition:opacity 1s ease-out; }
    .fade-out-paragraph { transition:opacity 1s ease-out; opacity:0; }

    .final-message { font-size:1.6rem; font-weight:700; color:#4CAF50; letter-spacing:1px; text-shadow:0 0 12px #4CAF50; text-align:center; animation:finalGlow 2s ease-in-out infinite; }
    @keyframes finalGlow { 0%,100% { text-shadow:0 0 10px #4CAF50; transform:scale(1); } 50% { text-shadow:0 0 20px #4CAF50,0 0 30px #4CAF50; transform:scale(1.05); } }

    /* 중앙 재등장 레이어 */
    .center-stage { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:999; background:transparent; animation:fadeIn .8s ease; padding:20px; flex-direction:column; }

    /* 4개 고정 표시 그리드 */
    .cheer-grid { display:grid; grid-template-columns:1fr; gap:12px; width:100%; max-width:640px; margin-top:24px; }
    @media (min-width:560px){ .cheer-grid { grid-template-columns:1fr 1fr; } }

    .cheer-card { background:rgba(255,255,255,0.04); border:1px solid #2a2a2a; border-radius:10px; padding:14px 16px; }
    .cheer-card .cheer-content { font-size:1.1rem; color:#eaeaea; margin-bottom:8px; line-height:1.4; }
    .cheer-card .cheer-author  { font-size:0.9rem; color:rgba(255,255,255,0.6); font-style:italic; text-align:right; }

    /* 랜덤 버스트 메시지 */
    .ephemeral-cheer {
      position:fixed; z-index:1200; pointer-events:none;
      opacity:0; transform:translate(-50%,-50%) scale(0.9);
      transition:opacity .25s ease, transform .25s ease;
      color:rgba(255,255,255,0.92); font-weight:700; text-shadow:0 0 8px rgba(76,175,80,0.45);
      will-change:transform, opacity;
    }
    .ephemeral-cheer.show { opacity:1; transform:translate(-50%,-50%) scale(1); }
    .ephemeral-cheer.fade { opacity:0; transform:translate(-50%,-50%) scale(0.85); }

    /* 게임 종료 페이지 */
    .game-end-container { position:fixed; inset:0; background:#000; z-index:1000; display:flex; align-items:center; justify-content:center; padding:20px; }
    .game-end-content { text-align:center; animation:fadeIn 2s ease-in-out; }
    .end-message { color:#fff; }
    .end-main-text { font-size:1.4rem; font-weight:500; margin-bottom:2rem; color:#e8e8e8; line-height:1.6; }
    .end-thanks { font-size:1.1rem; font-weight:400; margin-bottom:3rem; color:#ccc; }
    .author-signature { margin-bottom:3rem; font-style:italic; color:#aaa; font-size:1rem; }
    .the-end { font-size:1.8rem; font-weight:600; color:#fff; letter-spacing:3px; margin-top:2rem; }

    /* 모바일 */
    @media (max-width:768px){
      .content { font-size:.9rem !important; line-height:1.6 !important; }
      .title { font-size:1.4rem; }
      .container { padding:20px 10px; }
      .input-section { padding:1.2rem; margin:2rem 0; }
      .typing-text { font-size:1.1rem; }
      .green-message { font-size:1.3rem; }
      .end-main-text { font-size:1.2rem; }
      .end-thanks { font-size:1rem; }
      .cheer-card .cheer-content { font-size:1rem; }
      .cheer-card .cheer-author { font-size:0.85rem; }
    }
    @media (max-width:480px){
      .content { font-size:.85rem !important; line-height:1.5 !important; }
      .title { font-size:1.3rem; letter-spacing:.5px; }
      .input-section { padding:1rem; }
      .typing-text { font-size:1rem; }
      .green-message { font-size:1.2rem; }
      .cheer-card .cheer-content { font-size:0.95rem; }
      .cheer-card .cheer-author { font-size:0.8rem; }
    }

    ::-webkit-scrollbar { width:6px; }
    ::-webkit-scrollbar-track { background:#1a1a1a; }
    ::-webkit-scrollbar-thumb { background:#444; border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover { background:#666; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">작가의 말</h1>

    <div class="content">
      <p class="author-name">아...안녕하세요. 작가 루시안입니다. 한분 한분</p>
      <p>직접 뵙고 인사드리고 싶지만 그럴 수 없어 아쉽습니다.</p>

      <p class="section-break">게임은 어떠셨나요? 만족할만한 결말이었나요? 각자의</p>
      <p>임무는 어떻게 느껴지셨나요? 각자가</p>
      <p>은밀하게 움직였어야 했을텐데 어떠셨는지 궁금합니다.</p>

      <p class="section-break">끝나고 나서 결말이 맘에 안드시는 분들도 있을거에요.</p>
      <p>나였어도 그렇게 생각할거에요. 운명은 정해진거라니...</p>
      <p>지금도 전 운명은 정해져 있다고 생각해요. 그렇지</p>
      <p>않다면, 세상은 너무 불확실하니까요. 싫었던 순간, 좋</p>
      <p>았던 순간 모두 당신의 운명이에요.</p>
      <p>어떤 의미든 모든 순간이 소중했을 거라고 생각해요.</p>

      <p class="section-break last-paragraph">지금 이 시간에도 운명을 바꾸기 위해 노력하는 다른 이진욱, 김기태, 고윤정, 이태성이 있을거에요. 그들에게 진심 어린 응원을 남겨볼까요? 다른 이들에게 힘이 될지도...?</p>
    </div>

    <div class="input-section" id="inputSection">
      <div class="input-group">
        <label for="nickname">닉네임</label>
        <input type="text" id="nickname" placeholder="닉네임을 입력해주세요" maxlength="20">
      </div>

      <div class="textarea-group">
        <label for="message">응원글</label>
        <textarea id="message" placeholder="진심 어린 응원의 메시지를 남겨주세요..."></textarea>
      </div>

      <p class="small-text">(아직도 운명을 바꾸고 싶다면, 진심을 다해 응원글을 적어주세요.)</p>
    </div>

    <button class="final-button" id="finalButton" onclick="goToFinalPage()">마지막 페이지</button>
  </div>

  <!-- Firebase & Logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCLzzo1F4H7-d-LhrbxsDzULJG86r2vKZU",
      authDomain: "cheer-b2471.firebaseapp.com",
      projectId: "cheer-b2471",
      storageBucket: "cheer-b2471.firebasestorage.app",
      messagingSenderId: "403286093961",
      appId: "1:403286093961:web:8613cf197b75c1e3579658"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    class CheerMessageDB {
      constructor() { this.collectionName = 'cheerMessages'; }

      async saveMessage(nickname, message) {
        const newMessage = {
          nickname: nickname.trim() || '익명',
          message: message.trim(),
          timestamp: serverTimestamp(),
          createdAt: new Date().toISOString()
        };
        const docRef = await addDoc(collection(db, this.collectionName), newMessage);
        return { id: docRef.id, ...newMessage };
      }

      async getRecentMessages(count = 4) {
        const q = query(collection(db, this.collectionName), orderBy('timestamp', 'desc'), limit(count));
        const snap = await getDocs(q);
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }

      async getAllMessages() {
        const q = query(collection(db, this.collectionName), orderBy('timestamp', 'desc'));
        const snap = await getDocs(q);
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }
    }

    const cheerDB = new CheerMessageDB();
    window.cheerDB = cheerDB; // 디버깅용

    function isEncouragementMessage(text) {
      const encouragementKeywords = [
        '힘내','화이팅','응원','파이팅','굿럭','좋은','멋진','대단한','최고','잘할',
        '할 수 있','해낼','성공','이겨','극복','버텨','포기하지','끝까지','노력',
        '희망','믿어','꿈','목표','도전','용기','자신감','열정','긍정','밝은'
      ];
      return encouragementKeywords.some(k => text.includes(k)) || text.length > 10;
    }

    async function goToFinalPage() {
      const nickname = document.getElementById('nickname').value.trim();
      const message  = document.getElementById('message').value.trim();

      if (!nickname) { alert('닉네임을 입력해주세요.'); document.getElementById('nickname').focus(); return; }
      if (!message)  { alert('응원글을 작성해주세요.'); document.getElementById('message').focus(); return; }

      const isEncouragement = isEncouragementMessage(message);

      try {
        if (isEncouragement) {
          await cheerDB.saveMessage(nickname, message); // 저장 후 연출
          startEncouragementSequence();
        } else {
          showGameEndPage();
        }
      } catch (err) {
        console.error('저장/분기 오류:', err);
        isEncouragement ? startEncouragementSequence() : showGameEndPage();
      }
    }
    // 모듈 스코프 → 전역으로 노출
    window.goToFinalPage = goToFinalPage;

    function showGameEndPage() {
      document.querySelector('.container').style.display = 'none';
      const endPageHTML = `
        <div class="game-end-container">
          <div class="game-end-content">
            <div class="end-message">
              <p class="end-main-text">아쉽게도 게임은 여기까지입니다.</p>
              <p class="end-thanks">즐겨주셔서 감사드립니다!</p>
              <div class="author-signature"><p>-작가 루시안 드림-</p></div>
              <div class="the-end"><p>THE END.</p></div>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', endPageHTML);
    }

    function startEncouragementSequence() {
      const container = document.querySelector('.container');
      container.classList.add('animation-done');

      const inputSection = document.getElementById('inputSection');
      const finalButton  = document.getElementById('finalButton');

      inputSection.classList.add('fade-out');
      finalButton.classList.add('fade-out');

      setTimeout(() => {
        finalButton.style.display = 'none';
        inputSection.classList.remove('fade-out');
        inputSection.style.opacity = '1';
        inputSection.style.background = 'transparent';
        inputSection.style.borderColor = 'transparent';

        inputSection.innerHTML = `
          <div class="typing-area">
            <div class="typing-text" id="typingText"></div>
          </div>`;
        startTypingAnimation();
      }, 800);
    }

    function startTypingAnimation() {
      const typingElement = document.getElementById('typingText');
      const text = "아쉽게도 게임은 여기까지";
      let i = 0;
      const t = setInterval(() => {
        typingElement.textContent = text.slice(0, i + 1);
        i++;
        if (i >= text.length) { clearInterval(t); setTimeout(startGlitchPhase, 1000); }
      }, 100);
    }

    function startGlitchPhase() {
      const typingElement = document.getElementById('typingText');
      const container = document.querySelector('.container');

      typingElement.classList.add('glitching');
      container.classList.add('screen-shake');

      setTimeout(() => {
        typingElement.classList.remove('glitching');
        container.classList.remove('screen-shake');
        typingElement.style.display = 'none';
        startGreenMessage();
      }, 3000);
    }

    function startGreenMessage() {
      const mount = document.getElementById('inputSection');
      mount.querySelector('.typing-area')
        .insertAdjacentHTML('beforeend','<div class="green-message" id="greenMessage"></div>');

      const greenElement = document.getElementById('greenMessage');
      const text = "아직 포기 하지마. 운명은 바꿀 수 있어.";
      let i = 0;
      const t = setInterval(() => {
        greenElement.textContent = text.slice(0, i + 1);
        i++;
        if (i >= text.length) { clearInterval(t); setTimeout(startCharacterExtraction, 800); }
      }, 80);
    }

    function startCharacterExtraction() {
      const contentParagraphs = document.querySelectorAll('.content p');
      const lastParagraph = document.querySelector('.last-paragraph');
      if (lastParagraph) lastParagraph.classList.add('fade-out-paragraph');

      let idx = 0;
      const step = setInterval(() => {
        if (idx < contentParagraphs.length) {
          const p = contentParagraphs[idx];
          const firstChar = (p.textContent || '').charAt(0) || '';
          const rest = (p.textContent || '').slice(1);

          p.innerHTML = `
            <span class="first-char-only">${firstChar}</span>
            <span class="fade-out-text">${rest}</span>`;
          setTimeout(() => {
            const fade = p.querySelector('.fade-out-text');
            if (fade) fade.classList.add('fade-out');
          }, 80);

          idx++;
        } else {
          clearInterval(step);
          setTimeout(fadeOutToBlankAndShowFinal, 900);
        }
      }, 480);
    }

    function fadeOutToBlankAndShowFinal() {
      const firstChars = document.querySelectorAll('.first-char-only');
      const green = document.getElementById('greenMessage');

      firstChars.forEach(el => el.classList.add('fade-out-fast'));
      if (green) green.classList.add('fade-out-fast');

      setTimeout(() => {
        const title = document.querySelector('.title');
        const content = document.querySelector('.content');
        const inputSection = document.getElementById('inputSection');

        if (title) { title.classList.add('fade-out-fast'); setTimeout(()=> title.style.display='none', 600); }
        if (content){ content.classList.add('fade-out-fast'); setTimeout(()=> content.style.display='none',600); }
        if (inputSection){ inputSection.classList.add('fade-out-fast'); setTimeout(()=> inputSection.style.display='none',600); }

        setTimeout(() => {
          const center = document.createElement('div');
          center.className = 'center-stage';
          center.innerHTML = `<div class="final-message">아직 게임은 끝나지 않았어.</div>`;
          document.body.appendChild(center);

          // 2초 후 최근 4개 + 버스트 시작
          setTimeout(() => { showCheerMessages(center); }, 2000);
        }, 650);
      }, 620);
    }

    /** 최근 4개 그리드 표시 + 남은 메시지 20개 랜덤 버스트 */
    async function showCheerMessages(centerElement) {
      // 전체 메시지 조회
      let all = [];
      try { all = await cheerDB.getAllMessages(); } catch(e){ console.warn('응원글 불러오기 실패:', e); }

      // 없으면 안내 문구 (샘플은 로드 시 주입됨)
      if (!all || all.length === 0) {
        const finalMessage = centerElement.querySelector('.final-message');
        if (finalMessage) {
          finalMessage.style.opacity = '0';
          setTimeout(() => {
            finalMessage.innerHTML = '첫 번째 응원 메시지를 남겨주세요!';
            finalMessage.style.opacity = '1';
          }, 500);
        }
        return;
      }

      // 최근 4개
      const featured = all.slice(0, 4);
      const featuredIds = new Set(featured.map(m => m.id));

      // 그리드 생성 및 표시
      const grid = document.createElement('div');
      grid.className = 'cheer-grid';
      featured.forEach(item => {
        const card = document.createElement('div');
        card.className = 'cheer-card';
        const text = (item.message || '').toString();
        const nick = (item.nickname || '익명').toString();
        card.innerHTML = `
          <div class="cheer-content">"${text}"</div>
          <div class="cheer-author">- ${nick} -</div>`;
        grid.appendChild(card);
      });
      centerElement.appendChild(grid);

      // 버스트 풀(최근 4개 제외)
      const pool = all.filter(m => !featuredIds.has(m.id));
      if (pool.length === 0) return;

      // 20개 랜덤 추출 (중복 없이)
      const count = Math.min(20, pool.length);
      const picks = pickRandomUnique(pool, count);

      // 0~6000ms 사이 랜덤 지연으로 빠르게 등장/퇴장
      picks.forEach((msg, i) => {
        const delay = randInt(0, 6000);
        spawnEphemeral(msg, delay);
      });
    }

    /** 화면 곳곳에 작은 텍스트로 빠르게 등장/사라짐 */
    function spawnEphemeral(msg, delayMs) {
      setTimeout(() => {
        const el = document.createElement('div');
        el.className = 'ephemeral-cheer';

        const fontMin = 0.78, fontMax = 1.05; // rem
        const font = (Math.random() * (fontMax - fontMin) + fontMin).toFixed(2);

        const rot = randInt(-12, 12); // 회전
        const vw = window.innerWidth, vh = window.innerHeight;

        // 화면 가장자리 피해서 배치 (5%~95% / 10%~90%)
        const leftPct = randInt(5, 95);
        const topPct  = randInt(10, 90);

        el.style.left = `${leftPct}vw`;
        el.style.top  = `${topPct}vh`;
        el.style.fontSize = `${font}rem`;
        el.style.transform = `translate(-50%,-50%) rotate(${rot}deg) scale(0.9)`;

        const text = (msg.message || '').toString();
        const nick = (msg.nickname || '익명').toString();
        el.textContent = `"${text}" - ${nick}`;

        document.body.appendChild(el);

        // 등장
        requestAnimationFrame(() => {
          el.classList.add('show');
        });

        // 900~1400ms 후 퇴장
        const life = randInt(900, 1400);
        setTimeout(() => {
          el.classList.add('fade');
          setTimeout(() => el.remove(), 300);
        }, life);
      }, delayMs);
    }

    /* 유틸 */
    function pickRandomUnique(arr, n) {
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy.slice(0, n);
    }
    function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }

    // 초기 샘플 데이터 (처음엔 비어 있을 수 있으니 주입)
    window.addEventListener('load', async () => {
      try {
        const existing = await cheerDB.getAllMessages();
        if (!existing || existing.length === 0) {
          await cheerDB.saveMessage('응원단장', '힘내세요! 항상 응원하고 있어요!');
          await cheerDB.saveMessage('열정맨', '포기하지 마세요! 끝까지 화이팅!');
          await cheerDB.saveMessage('희망이', '당신은 충분히 잘하고 있어요!');
          await cheerDB.saveMessage('용기쌤', '어려운 시기지만 반드시 극복할 거예요!');
          await cheerDB.saveMessage('빛나는별', '오늘도 한 걸음, 그게 충분해요.');
          await cheerDB.saveMessage('브레이버', '두려움보다 용기가 조금만 더 크면 돼요!');
          await cheerDB.saveMessage('스마일', '당신의 웃음이 모두를 밝게 해요 :)');
          await cheerDB.saveMessage('러너', '멈추지 않는 한 우리는 도착할 거예요.');
          await cheerDB.saveMessage('드리머', '꿈꾸는 순간, 이미 반은 이룬 거예요.');
          await cheerDB.saveMessage('서포터', '작은 응원도 큰 힘이 됩니다!');
          // 더 필요하면 자유롭게 추가 가능
        }
      } catch (e) {
        console.warn('샘플 주입 실패:', e);
      }
      document.getElementById('nickname').focus();
    });

    // 엔터키로 포커스 이동
    document.getElementById('nickname').addEventListener('keypress', e => {
      if (e.key === 'Enter') document.getElementById('message').focus();
    });
  </script>
</body>
</html>
