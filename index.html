<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>작가의 말 - 루시안</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      font-family:'Noto Serif KR', serif;
      background:#000; color:#fff; padding:15px;
      min-height:100vh; overflow-x:hidden;
    }

    .container {
      max-width:600px; margin:0 auto; padding:30px 15px;
      animation:fadeIn 1.5s ease-in-out forwards;
    }
    .container.animation-done { animation:none; }

    @keyframes fadeIn {
      from { opacity:0; transform:translateY(30px); }
      to   { opacity:1; transform:translateY(0); }
    }

    .title {
      font-size:1.6rem; font-weight:600; text-align:center;
      margin-bottom:2.5rem; color:#fff; letter-spacing:1px;
    }

    .content {
      font-size:1rem; font-weight:400; margin-bottom:2.5rem;
      text-align:justify; color:#e8e8e8; line-height:1.7;
    }
    .content p { margin-bottom:0.3rem; }

    .author-name { color:#ccc; font-weight:500; margin-bottom:0; }
    .section-break { margin-top:1.5rem; }

    .input-section {
      margin:2.5rem 0; background:rgba(20,20,20,0.8);
      padding:1.5rem; border-radius:12px; border:1px solid #333;
      transition:opacity .8s ease-out, background .3s ease, border-color .3s ease;
    }

    .input-group { margin-bottom:1.2rem; }
    .input-group label {
      display:block; font-size:.9rem; font-weight:500; margin-bottom:.6rem; color:#fff;
    }
    .input-group input {
      width:100%; padding:.8rem; background:#1a1a1a; border:2px solid #333; border-radius:6px; color:#fff;
      font-family:'Noto Serif KR', serif; font-size:14px; transition:border-color .3s ease;
    }
    .input-group input:focus { outline:none; border-color:#666; background:#222; }
    .input-group input::placeholder { color:#777; }

    .textarea-group { margin-bottom:1rem; }
    .textarea-group label {
      display:block; font-size:.9rem; font-weight:500; margin-bottom:.6rem; color:#fff;
    }
    .textarea-group textarea {
      width:100%; min-height:120px; padding:.8rem; background:#1a1a1a;
      border:2px solid #333; border-radius:6px; color:#fff; font-family:'Noto Serif KR', serif;
      font-size:14px; resize:vertical; line-height:1.5; transition:border-color .3s ease;
    }
    .textarea-group textarea:focus { outline:none; border-color:#666; background:#222; }
    .textarea-group textarea::placeholder { color:#777; }

    .small-text {
      font-size:.75rem; color:#999; text-align:center; margin-bottom:1.5rem; font-style:italic;
    }

    .final-button {
      display:block; width:100%; max-width:280px; margin:2.5rem auto 0; padding:1rem 1.5rem;
      background:linear-gradient(135deg,#2a2a2a 0%,#1a1a1a 100%); border:2px solid #444; color:#fff;
      font-family:'Noto Serif KR', serif; font-size:1rem; font-weight:500; border-radius:8px;
      cursor:pointer; transition:all .3s ease; text-decoration:none; text-align:center;
    }
    .final-button:hover { background:linear-gradient(135deg,#3a3a3a 0%,#2a2a2a 100%); border-color:#666; transform:translateY(-2px); box-shadow:0 5px 15px rgba(255,255,255,.1); }
    .final-button:active { transform:translateY(0); }

    /* 연출 공용 */
    .fade-out { opacity:0 !important; transition:opacity .8s ease; }
    .fade-out-fast { opacity:0 !important; transition:opacity .6s ease; }

    .typing-area { margin-top:2rem; text-align:center; font-family:'Noto Serif KR', serif; }
    .typing-text { font-size:1.3rem; color:#e8e8e8; font-weight:500; min-height:2rem; transition:color .3s ease; }

    .glitching {
      color:#ff4444 !important;
      animation:textGlitch .1s infinite;
    }
    @keyframes textGlitch {
      0%   { transform:translate(0);      text-shadow:2px 0 #f00, -2px 0 #0f0; }
      25%  { transform:translate(-1px,1px); text-shadow:-2px 0 #f00, 2px 0 #0f0; }
      50%  { transform:translate(1px,-1px); text-shadow:2px 0 #00f, -2px 0 #f00; }
      75%  { transform:translate(-1px,-1px); text-shadow:-2px 0 #0f0, 2px 0 #00f; }
      100% { transform:translate(1px,1px); text-shadow:2px 0 #f00, -2px 0 #0f0; }
    }

    .screen-shake { animation:screenShake .15s infinite; }
    @keyframes screenShake {
      0% { transform:translate(0,0) rotate(0deg); }
      25% { transform:translate(2px,2px) rotate(.5deg); }
      50% { transform:translate(-1px,1px) rotate(-.5deg); }
      75% { transform:translate(1px,-2px) rotate(.5deg); }
      100% { transform:translate(-2px,-1px) rotate(-.5deg); }
    }

    .green-message { font-size:1.5rem; font-weight:600; color:#4CAF50; margin-top:2rem; line-height:1.6; text-align:center; }

    .first-char-only { color:#ff0; font-weight:bold; font-size:1.1em; text-shadow:0 0 5px #ff0; }
    .fade-out-text { transition:opacity 1s ease-out; }
    .fade-out-paragraph { transition:opacity 1s ease-out; opacity:0; }

    .final-message {
      font-size:1.6rem; font-weight:700; color:#4CAF50; letter-spacing:1px;
      text-shadow:0 0 12px #4CAF50; text-align:center; animation:finalGlow 2s ease-in-out infinite;
    }
    @keyframes finalGlow {
      0%,100% { text-shadow:0 0 10px #4CAF50; transform:scale(1); }
      50%     { text-shadow:0 0 20px #4CAF50, 0 0 30px #4CAF50; transform:scale(1.05); }
    }

    /* 중앙 재등장 레이어 */
    .center-stage {
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:999; background:transparent; animation:fadeIn .8s ease;
      padding:20px; flex-direction:column;
    }

    /* 응원글 표시 스타일 */
    .cheer-display {
      text-align:center; opacity:0; transform:translateY(20px);
      transition:all 0.8s ease; margin-top:50px;
    }
    .cheer-display.show { opacity:1; transform:translateY(0); }
    .cheer-content { font-size:1.8rem; font-weight:600; margin-bottom:15px; line-height:1.4; color:#fff; }
    .cheer-author { font-size:1rem; color:rgba(255,255,255,0.7); font-style:italic; }

    /* 랜덤 응원글 (전역 .content와 충돌 피하려고 클래스 분리) */
    .random-cheer {
      position:fixed; z-index:998; pointer-events:none;
      opacity:0; transform:scale(0.8); transition:all 0.5s ease;
      text-align:center; max-width:300px; padding:10px;
    }
    .random-cheer.show { opacity:1; transform:scale(1); }
    .random-cheer .r-content { 
      font-size:1rem; font-weight:500; color:rgba(255,255,255,0.9); 
      margin-bottom:5px; line-height:1.3;
    }
    .random-cheer .r-author { 
      font-size:0.8rem; color:rgba(255,255,255,0.6); 
      font-style:italic; 
    }

    /* 완료/정답/에필로그 영역 */
    .completion-container {
      position:fixed; inset:0; background:#000; z-index:1000;
      overflow-y:auto; padding:20px;
      animation:fadeIn 1s ease;
    }
    .completion-content { 
      text-align:left; max-width:600px; margin:0 auto; color:#fff; 
      font-family:'Noto Serif KR', serif; line-height:1.6;
      padding-bottom:2rem;
    }
    .completion-text { font-size:0.75rem; margin-bottom:3rem; }
    .completion-text p { margin-bottom:0.5rem; }

    .card-input-section {
      text-align:center; margin-top:2rem; 
      padding:2rem; background:rgba(20,20,20,0.8); 
      border-radius:12px; border:1px solid #333;
    }
    .input-instruction { font-size:1rem; margin-bottom:1rem; color:#fff; font-weight:500; }
    .card-input-section input {
      width:200px; padding:0.8rem; background:#1a1a1a; 
      border:2px solid #333; border-radius:6px; color:#fff;
      font-family:'Noto Serif KR', serif; font-size:14px; 
      text-align:center; margin-bottom:1rem;
    }
    .card-input-section input:focus { outline:none; border-color:#666; background:#222; }
    .card-input-section button {
      display:block; margin:1rem auto 0; padding:0.8rem 2rem;
      background:linear-gradient(135deg,#2a2a2a 0%,#1a1a1a 100%); 
      border:2px solid #444; color:#fff; font-family:'Noto Serif KR', serif; 
      font-size:1rem; border-radius:8px; cursor:pointer; transition:all .3s ease;
    }
    .card-input-section button:hover { 
      background:linear-gradient(135deg,#3a3a3a 0%,#2a2a2a 100%); 
      border-color:#666; transform:translateY(-2px); 
    }

    .correct-ending-container {
      position:fixed; inset:0; background:#000; z-index:1000;
      display:flex; align-items:center; justify-content:center; padding:20px;
      animation:fadeIn 1s ease;
    }
    .correct-ending-content { text-align:center; max-width:600px; color:#fff; font-family:'Noto Serif KR', serif; line-height:1.6; }
    .correct-ending-text { font-size:1.1rem; margin-bottom:3rem; }
    .correct-ending-text p { margin-bottom:1rem; }
    .epilogue-button-section { text-align:center; margin-top:2rem; }
    .epilogue-button-section button {
      padding:1rem 2.5rem; background:linear-gradient(135deg,#2a2a2a 0%,#1a1a1a 100%); 
      border:2px solid #444; color:#fff; font-family:'Noto Serif KR', serif; 
      font-size:1.1rem; border-radius:8px; cursor:pointer; transition:all .3s ease;
    }
    .epilogue-button-section button:hover { 
      background:linear-gradient(135deg,#3a3a3a 0%,#2a2a2a 100%); 
      border-color:#666; transform:translateY(-2px); 
    }

    .epilogue-container {
      position:fixed; inset:0; background:#000; z-index:1000;
      overflow-y:auto; padding:20px; animation:fadeIn 1s ease;
    }
    .epilogue-content { text-align:left; max-width:700px; margin:0 auto; color:#fff; font-family:'Noto Serif KR', serif; line-height:1.7; padding-bottom:2rem; }
    .epilogue-text { font-size:0.95rem; }
    .epilogue-text p { margin-bottom:0.8rem; }

    /* 게임 종료 페이지 */
    .game-end-container {
      position:fixed; inset:0; background:#000; z-index:1000;
      display:flex; align-items:center; justify-content:center; padding:20px;
    }
    .game-end-content { text-align:center; animation:fadeIn 2s ease-in-out; }
    .end-message { color:#fff; }
    .end-main-text { font-size:1.4rem; font-weight:500; margin-bottom:2rem; color:#e8e8e8; line-height:1.6; }
    .end-thanks { font-size:1.1rem; font-weight:400; margin-bottom:3rem; color:#ccc; }
    .author-signature { margin-bottom:3rem; font-style:italic; color:#aaa; font-size:1rem; }
    .the-end { font-size:1.8rem; font-weight:600; color:#fff; letter-spacing:3px; margin-top:2rem; }

    /* 모바일 */
    @media (max-width:768px){
      .content { font-size:.9rem !important; line-height:1.6 !important; }
      .title { font-size:1.4rem; }
      .container { padding:20px 10px; }
      .input-section { padding:1.2rem; margin:2rem 0; }
      .typing-text { font-size:1.1rem; }
      .green-message { font-size:1.3rem; }
      .end-main-text { font-size:1.2rem; }
      .end-thanks { font-size:1rem; }
      .cheer-content { font-size:1.4rem; }
      .cheer-author { font-size:0.9rem; }
      .epilogue-content { max-width:100%; }
      .epilogue-text { font-size:0.85rem; line-height:1.6; }
    }
    @media (max-width:480px){
      .content { font-size:.85rem !important; line-height:1.5 !important; }
      .title { font-size:1.3rem; letter-spacing:.5px; }
      .input-section { padding:1rem; }
      .typing-text { font-size:1rem; }
      .green-message { font-size:1.2rem; }
      .cheer-content { font-size:1.2rem; }
      .cheer-author { font-size:0.8rem; }
    }

    ::-webkit-scrollbar { width:6px; }
    ::-webkit-scrollbar-track { background:#1a1a1a; }
    ::-webkit-scrollbar-thumb { background:#444; border-radius:3px; }
    ::-webkit-scrollbar-thumb:hover { background:#666; }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="title">작가의 말</h1>

    <div class="content">
      <p class="author-name">아...안녕하세요. 작가 루시안입니다. 한분 한분</p>
      <p>직접 뵙고 인사드리고 싶지만 그럴 수 없어 아쉽습니다.</p>

      <p class="section-break">게임은 어떠셨나요? 만족할만한 결말이었나요? 각자의</p>
      <p>임무는 어떻게 느껴지셨나요? 각자가</p>
      <p>은밀하게 움직였어야 했을텐데 어떠셨는지 궁금합니다.</p>

      <p class="section-break">끝나고 나서 결말이 맘에 안드시는 분들도 있을거에요.</p>
      <p>나였어도 그렇게 생각할거에요. 운명은 정해진거라니...</p>
      <p>지금도 전 운명은 정해져 있다고 생각해요. 그렇지</p>
      <p>않다면, 세상은 너무 불확실하니까요. 싫었던 순간, 좋</p>
      <p>았던 순간 모두 당신의 운명이에요.</p>
      <p>어떤 의미든 모든 순간이 소중했을 거라고 생각해요.</p>

      <p class="section-break last-paragraph">지금 이 시간에도 운명을 바꾸기 위해 노력하는 다른 이진욱, 김기태, 고윤정, 이태성이 있을거에요. 그들에게 진심 어린 응원을 남겨볼까요? 다른 이들에게 힘이 될지도...?</p>
    </div>

    <div class="input-section" id="inputSection">
      <div class="input-group">
        <label for="nickname">닉네임</label>
        <input type="text" id="nickname" placeholder="닉네임을 입력해주세요" maxlength="20">
      </div>

      <div class="textarea-group">
        <label for="message">응원글</label>
        <textarea id="message" placeholder="진심 어린 응원의 메시지를 남겨주세요..."></textarea>
      </div>

      <p class="small-text">(아직도 운명을 바꾸고 싶다면, 진심을 다해 응원글을 적어주세요.)</p>
    </div>

    <button class="final-button" id="finalButton">마지막 페이지</button>
  </div>

  <!-- Firebase & Logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp, getCountFromServer
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCLzzo1F4H7-d-LhrbxsDzULJG86r2vKZU",
      authDomain: "cheer-b2471.firebaseapp.com",
      projectId: "cheer-b2471",
      storageBucket: "cheer-b2471.firebasestorage.app",
      messagingSenderId: "403286093961",
      appId: "1:403286093961:web:8613cf197b75c1e3579658"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    class CheerMessageDB {
      constructor() { this.collectionName = 'cheerMessages'; }

      async saveMessage(nickname, message) {
        const newMessage = {
          nickname: nickname.trim() || '익명',
          message: message.trim(),
          timestamp: serverTimestamp(),
          createdAt: new Date().toISOString()
        };
        const docRef = await addDoc(collection(db, this.collectionName), newMessage);
        return { id: docRef.id, ...newMessage };
      }

      async getRecentMessages(count = 4) {
        const qy = query(
          collection(db, this.collectionName),
          orderBy('timestamp', 'desc'),
          limit(count)
        );
        const snap = await getDocs(qy);
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }

      async getAllMessages() {
        const qy = query(
          collection(db, this.collectionName),
          orderBy('timestamp', 'desc')
        );
        const snap = await getDocs(qy);
        return snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }

      async countAll() {
        const snap = await getCountFromServer(collection(db, this.collectionName));
        return snap.data().count || 0;
      }

      async seedSamples(samples) {
        for (const [nick, msg] of samples) {
          await this.saveMessage(nick, msg);
          await new Promise(r => setTimeout(r, 60));
        }
      }
    }

    const cheerDB = new CheerMessageDB();

    function isEncouragementMessage(text) {
      const encouragementKeywords = [
        '힘내','화이팅','응원','파이팅','굿럭','좋은','멋진','대단한','최고','잘할',
        '할 수 있','해낼','성공','이겨','극복','버텨','포기하지','끝까지','노력',
        '희망','믿어','꿈','목표','도전','용기','자신감','열정','긍정','밝은'
      ];
      return encouragementKeywords.some(k => text.includes(k)) || text.length > 10;
    }

    // ====== 메인 흐름 ======
    async function goToFinalPage() {
      const nickname = document.getElementById('nickname').value.trim();
      const message  = document.getElementById('message').value.trim();

      if (!nickname) { alert('닉네임을 입력해주세요.'); document.getElementById('nickname').focus(); return; }
      if (!message)  { alert('응원글을 작성해주세요.'); document.getElementById('message').focus(); return; }

      const isEncouragement = isEncouragementMessage(message);

      try {
        if (isEncouragement) {
          await cheerDB.saveMessage(nickname, message);
          startEncouragementSequence();
        } else {
          showGameEndPage();
        }
      } catch (err) {
        console.error('저장/분기 오류:', err);
        isEncouragement ? startEncouragementSequence() : showGameEndPage();
      }
    }

    function showGameEndPage() {
      // 기존 오버레이 제거
      document.querySelector('.completion-container')?.remove();
      document.querySelector('.correct-ending-container')?.remove();
      document.querySelector('.epilogue-container')?.remove();

      document.querySelector('.container').style.display = 'none';
      const endPageHTML = `
        <div class="game-end-container">
          <div class="game-end-content">
            <div class="end-message">
              <p class="end-main-text">아쉽게도 게임은 여기까지입니다.</p>
              <p class="end-thanks">즐겨주셔서 감사드립니다!</p>
              <div class="author-signature"><p>-작가 루시안 드림-</p></div>
              <div class="the-end"><p>THE END.</p></div>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', endPageHTML);
    }

    function startEncouragementSequence() {
      const container = document.querySelector('.container');
      container.classList.add('animation-done');

      const inputSection = document.getElementById('inputSection');
      const finalButton  = document.getElementById('finalButton');

      inputSection.classList.add('fade-out');
      finalButton.classList.add('fade-out');

      setTimeout(() => {
        finalButton.style.display = 'none';
        inputSection.classList.remove('fade-out');
        inputSection.style.opacity = '1';
        inputSection.style.background = 'transparent';
        inputSection.style.borderColor = 'transparent';

        inputSection.innerHTML = `
          <div class="typing-area">
            <div class="typing-text" id="typingText"></div>
          </div>`;
        startTypingAnimation();
      }, 800);
    }

    function startTypingAnimation() {
      const typingElement = document.getElementById('typingText');
      const text = "아쉽게도 게임은 여기까지";
      let i = 0;
      const t = setInterval(() => {
        typingElement.textContent = text.slice(0, i + 1);
        i++;
        if (i >= text.length) { clearInterval(t); setTimeout(startGlitchPhase, 1000); }
      }, 100);
    }

    function startGlitchPhase() {
      const typingElement = document.getElementById('typingText');
      const container = document.querySelector('.container');

      typingElement.classList.add('glitching');
      container.classList.add('screen-shake');

      setTimeout(() => {
        typingElement.classList.remove('glitching');
        container.classList.remove('screen-shake');
        typingElement.style.display = 'none';
        startGreenMessage();
      }, 3000);
    }

    function startGreenMessage() {
      const mount = document.getElementById('inputSection');
      mount.querySelector('.typing-area')
        .insertAdjacentHTML('beforeend','<div class="green-message" id="greenMessage"></div>');

      const greenElement = document.getElementById('greenMessage');
      const text = "아직 포기 하지마. 운명은 바꿀 수 있어.";
      let i = 0;
      const t = setInterval(() => {
        greenElement.textContent = text.slice(0, i + 1);
        i++;
        if (i >= text.length) { clearInterval(t); setTimeout(startCharacterExtraction, 800); }
      }, 80);
    }

    function startCharacterExtraction() {
      const contentParagraphs = document.querySelectorAll('.content p');
      const lastParagraph = document.querySelector('.last-paragraph');
      if (lastParagraph) lastParagraph.classList.add('fade-out-paragraph');

      let idx = 0;
      const step = setInterval(() => {
        if (idx < contentParagraphs.length) {
          const p = contentParagraphs[idx];
          const firstChar = (p.textContent || '').charAt(0) || '';
          const rest = (p.textContent || '').slice(1);

          p.innerHTML = `
            <span class="first-char-only">${firstChar}</span>
            <span class="fade-out-text">${rest}</span>`;
          setTimeout(() => {
            const fade = p.querySelector('.fade-out-text');
            if (fade) fade.classList.add('fade-out');
          }, 80);

          idx++;
        } else {
          clearInterval(step);
          setTimeout(fadeOutToBlankAndShowFinal, 900);
        }
      }, 480);
    }

    function fadeOutToBlankAndShowFinal() {
      const firstChars = document.querySelectorAll('.first-char-only');
      const green = document.getElementById('greenMessage');

      firstChars.forEach(el => el.classList.add('fade-out-fast'));
      if (green) green.classList.add('fade-out-fast');

      setTimeout(() => {
        const title = document.querySelector('.title');
        const content = document.querySelector('.content');
        const inputSection = document.getElementById('inputSection');

        if (title) { title.classList.add('fade-out-fast'); setTimeout(()=> title.style.display='none', 600); }
        if (content){ content.classList.add('fade-out-fast'); setTimeout(()=> content.style.display='none',600); }
        if (inputSection){ inputSection.classList.add('fade-out-fast'); setTimeout(()=> inputSection.style.display='none',600); }

        setTimeout(() => {
          const center = document.createElement('div');
          center.className = 'center-stage';
          center.innerHTML = `<div class="final-message">아직 게임은 끝나지 않았어.</div>`;
          document.body.appendChild(center);

          setTimeout(() => { showCheerMessages(center); }, 2000);
        }, 650);
      }, 620);
    }

    async function showCheerMessages(centerElement) {
      let recentMessages = [];
      try {
        recentMessages = await cheerDB.getRecentMessages(4);
      } catch (e) {
        console.warn('응원글 불러오기 실패:', e);
      }

      const finalMessage = centerElement.querySelector('.final-message');

      if (!recentMessages || recentMessages.length === 0) {
        if (finalMessage) {
          finalMessage.style.opacity = '0';
          setTimeout(() => {
            finalMessage.innerHTML = '첫 번째 응원 메시지를 남겨주세요!';
            finalMessage.style.opacity = '1';
          }, 500);
        }
        return;
      }

      if (finalMessage) finalMessage.style.opacity = '0';

      setTimeout(() => {
        if (finalMessage) finalMessage.remove();
        showMessagesSequentially(centerElement, recentMessages, 0);
      }, 500);
    }

    function showMessagesSequentially(container, messages, index) {
      if (index >= messages.length) {
        setTimeout(() => {
          const lastDisplay = container.querySelector('.cheer-display');
          if (lastDisplay) {
            lastDisplay.classList.remove('show');
            setTimeout(() => {
              lastDisplay.remove();
              startRandomCheerAnimation(messages);
            }, 800);
          } else {
            startRandomCheerAnimation(messages);
          }
        }, 2000);
        return;
      }

      const data = messages[index] || {};
      const text = (data.message || '').toString();
      const nick = (data.nickname || '익명').toString();

      const existingDisplay = container.querySelector('.cheer-display');
      if (existingDisplay) {
        existingDisplay.classList.remove('show');
        setTimeout(() => {
          existingDisplay.remove();
          createAndShowMessage();
        }, 800);
      } else {
        createAndShowMessage();
      }

      function createAndShowMessage() {
        const cheerDisplay = document.createElement('div');
        cheerDisplay.className = 'cheer-display';
        cheerDisplay.innerHTML = `
          <div class="cheer-content">"${text}"</div>
          <div class="cheer-author">- ${nick} -</div>`;
        container.appendChild(cheerDisplay);
        setTimeout(() => { cheerDisplay.classList.add('show'); }, 100);
        setTimeout(() => { showMessagesSequentially(container, messages, index + 1); }, 2000);
      }
    }

    async function startRandomCheerAnimation(displayedMessages) {
      try {
        const allMessages = await cheerDB.getAllMessages();
        const displayedIds = new Set(displayedMessages.map(m => m.id));
        const remaining = allMessages.filter(m => !displayedIds.has(m.id));
        shuffleInPlace(remaining);
        const messagesToShow = remaining.slice(0, Math.min(20, remaining.length));

        if (messagesToShow.length === 0) {
          showCompletionMessage();
          return;
        }

        let i = 0;
        const showInterval = setInterval(() => {
          if (i >= messagesToShow.length) {
            clearInterval(showInterval);
            setTimeout(showCompletionMessage, 3000);
            return;
          }
          showRandomCheer(messagesToShow[i]);
          i++;
        }, 500);
      } catch (error) {
        console.error('랜덤 응원글 표시 오류:', error);
        showCompletionMessage();
      }
    }

    function showCompletionMessage() {
      const completionDiv = document.createElement('div');
      completionDiv.className = 'completion-container';
      completionDiv.innerHTML = `
        <div class="completion-content">
          <div class="completion-text">
            <p>알았어. 알았어. 그만 해도 좋아.</p>
            <br>
            <p>아까부터 누가 말하는거냐고? 음... 뭐라고 해야할까.<br>
            나로 말할 거 같으면... 인간들이 흔히 말하는 신이라는<br>
            존재 일수도 있고, 지금 너희의 이야기인 '운명의 세여신'의<br>
            여신일 수도 있고, '작가'라고 말하는 존재일수도 있어.</p>
            <br>
            <p>이 이야기는 나의 뜻대로 정해져 있어. 너희가 아무리<br>
            바꾸려고 한들, 바꿀 수 없다는 이야기야. 운명이란건<br>
            그런거야. 아무리 발버둥쳐도 바꿀 수 없는 것.</p>
            <br>
            <p>노력하면 뭐든지 되는 거 아니었냐고? 그런거...너희들이<br>
            만든 허상에 불과해. 될 사람은 노력하지 않아도 되고,<br>
            안될 사람은 아무리 노력해도 안되는 거, 그게 이 세상이야.</p>
            <br>
            <p>...너무 한거 아니냐고? 좋아. 그래 맞아. 내가 지금 굳이 나타나지<br>
            않아도 되는데 나타난건, 그래서 너희와 이야기하고 있는 건<br>
            아마 너희, 그리고 수많은 다른 이진욱, 김기태, 고윤정, 이태성의<br>
            의지가 모였기 때문일거야. 아마 이 이야기의 엔딩을 보고 그냥<br>
            끝냈던 사람들, 혹은 그 의지를 담아 진심어린 응원을 보내지<br>
            않았던 사람들은 아마 지금 나와 이야기하지 못하고 있을 거야.<br>
            그만큼 너희가 운명을 바꾸고자 하는 의지가 크다는 거겠지.</p>
            <br>
            <p>그런 너희에게 운명을 바꿀 마지막 기회를 줄게. 지금 너희가<br>
            가지고 있는 것, 그러니까 카드중에 하나를 이 이야기에서 없앨<br>
            기회를 줄게. 너희가 올바른 선택을 한다면, 원하는대로 운명을<br>
            바꿀 수 있을거야.</p>
            <br>
            <p>명심해. 기회는 한번 뿐이야. 잘 생각해서 판단하라구.</p>
          </div>
          <div class="card-input-section">
            <p class="input-instruction">카드 번호를 입력하세요.</p>
            <input type="text" id="cardNumber"
                   placeholder="카드 번호를 입력해주세요"
                   maxlength="10" inputmode="numeric"
                   autocomplete="off" autocapitalize="off">
            <button id="submitCard">확인</button>
          </div>
        </div>
      `;
      document.body.appendChild(completionDiv);

      // 🔒 오버레이 띄운 직후 화면을 맨 위로 고정 (모바일 키보드 자동 띄움 방지)
      requestAnimationFrame(() => {
        window.scrollTo({ top: 0, left: 0, behavior: 'auto' });
        completionDiv.scrollTop = 0;
      });

      // 이벤트 바인딩
      const submitBtn = completionDiv.querySelector('#submitCard');
      const cardInput = completionDiv.querySelector('#cardNumber');

      submitBtn.addEventListener('click', submitCardNumber);
      cardInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') submitCardNumber();
      });

      // ❌ 자동 focus 금지 (커서가 가지 않도록)
      // cardInput.focus();
    }

    function submitCardNumber() {
      const field = document.getElementById('cardNumber');
      const cardNumber = (field?.value || '').trim();
      if (!cardNumber) {
        alert('카드 번호를 입력해주세요.');
        // 자동 포커스는 하지 않음
        return;
      }
      if (cardNumber === '10') {
        showCorrectEnding();
      } else {
        // 오버레이 제거 후 일반 엔딩
        document.querySelector('.completion-container')?.remove();
        showGameEndPage();
      }
    }

    function showCorrectEnding() {
      document.querySelector('.completion-container')?.remove();

      const correctDiv = document.createElement('div');
      correctDiv.className = 'correct-ending-container';
      correctDiv.innerHTML = `
        <div class="correct-ending-content">
          <div class="correct-ending-text">
            <p>그걸로 괜찮은건가. 너희의 선택이 어떤 결과로 이어질까.</p>
            <p>이제 나와의 대화는 여기서 끝이야. 부디 원하는 대로 결과가 이루어지길 바래.</p>
            <p>그럼 안녕.</p>
          </div>
          <div class="epilogue-button-section">
            <button id="epilogueBtn">에필로그 보기</button>
          </div>
        </div>
      `;
      document.body.appendChild(correctDiv);

      correctDiv.querySelector('#epilogueBtn').addEventListener('click', showEpilogue);
    }

    function showEpilogue() {
      document.querySelector('.correct-ending-container')?.remove();

      const epilogueDiv = document.createElement('div');
      epilogueDiv.className = 'epilogue-container';
      epilogueDiv.innerHTML = `
        <div class="epilogue-content">
          <div class="epilogue-text">
            <p>"안녕하십니까! 오늘부로 강력 3팀으로 전입을 명 받은 이유정입니다!"</p>
            <p>모처럼 조용했던 강력 3팀이 갑자기 소란스러워진다. 자신의 자리에서 졸다가 깜짝 놀라 잠에서 깬 이진욱 형사는 짜증 섞인 말투로 말한다.</p>
            <p>"아이씨, 깜짝이야. 누가 이렇게 시끄럽게 인사를…"</p>
            <p>시끄러운 인사의 주인공에게 고개를 돌린 이진욱은 화를 내려다 순간 흠칫한다.</p>
            <p>놀랍게도 과거 자신이 소중히 여겼던 동료의 모습이, 그녀에게 어렴풋이 보였기 때문이다.</p>
            <p>"선배님! 말씀 많이 들었습니다! 강력 3팀의 불도저! 앞으로 선배님께 많이 배우겠습니다!"</p>
            <p>"흠… 너 이름이 뭐라고?"</p>
            <p>"이유정입니다! 잘 부탁드립니다!"</p>
            <p>"아오 시끄러워. 앞으로 내 앞에선 목소리 낮춰. 알겠나?"</p>
            <p>"네! 명심하겠습니다!"</p>
            <p>보란 듯이 더욱더 힘차게 대답한 그녀는, 이진욱을 향해 웃어 보인다.</p>
            <p>이진욱은 그런 그녀를 보며 떠올리고 싶지 않았던, 과거의 일들이 떠오른다.</p>
            <p>죄책감 때문일까. 그녀에겐 왠지 모를 미안함이 느껴진다.</p>
            <br><p style="text-align:center;">. . . . . .</p><br>
            <p>"선배님! 또 주무십니까!"</p>
            <p>깜짝 놀라 잠에서 깬 이진욱 형사는 어안이 벙벙한 듯 주변을 둘러본다.</p>
            <p>목소리를 따라 고개를 돌려보니, 이유정 형사가 자신을 보며 웃고 있다.</p>
            <p>"선배님! 뭐 안 좋은 꿈이라도 꾸셨나 봅니다. 하핫."</p>
            <p>안 좋은 꿈이라… 잘 기억은 안 나지만 어딘가 멀리, 긴 시간 동안 다녀온 기분이다.</p>
            <p>정신을 차리고 주변을 둘러보니, 강력 3팀 자신의 자리다. 그래, 매일 보던 그 익숙한 풍경. 하지만 왜 인지 모르게 낯설게 느껴진다.</p>
            <p>"2022년 12월 13일, 오늘의 뉴스입니다."</p>
            <p>TV에서 뉴스가 나오고 있다. 뭔가 중요한 날이었던 것 같은 기분이 든다.</p>
            <p>하지만 그것에 대해 생각할수록 머리가 깨질 듯이 아파진다. 그때 옆에 있던 이유정 형사가 누군가에게 인사를 한다.</p>
            <p>"서장님! 안녕하십니까!"</p>
            <p>서장? 이유정이 인사를 한 방향으로 시선을 돌려보니, 낯익은 모습의 남자가 나에게 인사를 해온다.</p>
            <p>"야, 진욱아. 서장이 왔으면 인사는 못할망정 반가운 척이라도 해야 하는 거 아니냐…?"</p>
            <p>그렇다. 내 친구. 경찰서장이었지…지금까지 쭉 그래왔을 텐데. 이진욱 형사는 이 상황이 무언가 어색하고 낯설다. 그때 어딘가에서 들려오는 전화 벨 소리.</p>
            <p>"진욱아, 전화 오잖아. 오늘 좀 이상하네… 잠이 덜 깼나?"</p>
            <p>주머니에서 휴대폰을 꺼내 화면을 보니 '아들'이라는 이름으로부터 전화가 오고 있다.</p>
            <p>아들? 나한테 아들이 있었나? 미심쩍은 기분으로 전화를 받는다.</p>
            <p>"여보세요. 아빠! 오늘 무슨 날인지 알지? 일찍 들어오기로 했잖아!"</p>
            <p>"… 오늘이 무슨 날 인데?"</p>
            <p>"아빠.. 몇 번이나 얘기했는데. 또 잊어버렸어? 내 생일이잖아…기대한 내가 잘못이다!"</p>
            <p>그러고는, 수화기 너머로 어떤 여성의 목소리가 들려온다.</p>
            <p>"어휴, 엄마 바꿔줘 봐. 여보! 오늘은 일찍 들어와! 현장 바쁜 거 나도 겪어봐서 다 알지만, 오늘 같은 날은 그래도 일찍 와! 준비하고 기다리고 있을 테니까."</p>
            <p>"고… 윤정…?"</p>
            <p>"그래. 왜, 이제 마누라 이름까지 까먹었어? 여튼 빨리 와! 기태한테도 얘기했으니까 기태랑 같이 와. 끊는다!"</p>
            <p>끊어진 전화를 보며, 이진욱 형사는 왠지 모를 안도감과 함께 기쁨의 감정이 솟구쳐 오른다.</p>
            <p>마치, 그 두 사람이 방금 전까지는 없었던 사람인 것처럼 느껴진다. 그때 갑자기 한 남성이 강력 3팀의 문을 박차고 들어오며 소리친다.</p>
            <p>"선배님들! 출동이요 출동! 살인사건이랍니다!"</p>
            <p>박정우였다. 강력 3팀의 6개월 차 신입이자 막내. 역시나 그에게도 평소와는 다른 무언가가 느껴지는 이진욱 형사는, 그를 보며 멍하니 생각에 잠긴다.</p>
            <p>"선배님. 준비 안 하세요? 출동이라잖아요!"</p>
            <p>미동도 없이 그의 자리에 앉아있는 이진욱 형사를 보며, 이유정 형사가 소리친다.</p>
            <p>"어.. 어. 그래 알았어."</p>
            <p>그제야 정신을 차린 듯 서둘러 장비를 챙기는 이진욱 형사. 모두가 출동하고 텅 빈 강력 3팀에는 틀어 놓은 TV소리만이 그 공간을 채우고 있다.</p>
            <p>"다음 뉴스입니다. 세계적으로 그 재능을 인정받고 있는 과학자 박지우 씨가, 중대발표를 한다고 합니다. 과학자였던 아버지의 뒤를 이어, JH연구소의 소장이 된 그는 세계를 깜짝 놀라게 할 만한 연구에 성공했다고 합니다. 오늘 15시에 예정되어 있는 기자회견은…"</p>
            <br><p style="text-align:center;">. . . . . .</p><br>
            <p style="text-align:center; font-size:1.2rem; font-weight:600;">THE END.</p>
            <br>
            <p style="text-align:center; color:#ccc;">작가 : 루시안</p>
            <p style="text-align:center; color:#ccc;">디자이너 : 맵씨</p>
            <p style="text-align:center; color:#ccc;">제작 : 미스터리게임즈</p>
          </div>
        </div>
      `;
      document.body.appendChild(epilogueDiv);
    }

    function showRandomCheer(message) {
      const randomDiv = document.createElement('div');
      randomDiv.className = 'random-cheer';

      const x = Math.random() * (window.innerWidth - 320) + 10;
      const y = Math.random() * (window.innerHeight - 100) + 10;
      randomDiv.style.left = x + 'px';
      randomDiv.style.top  = y + 'px';

      randomDiv.innerHTML = `
        <div class="r-content">"${message.message}"</div>
        <div class="r-author">- ${message.nickname} -</div>
      `;
      document.body.appendChild(randomDiv);

      setTimeout(() => { randomDiv.classList.add('show'); }, 60);
      setTimeout(() => {
        randomDiv.classList.remove('show');
        setTimeout(() => randomDiv.remove(), 450);
      }, 1500);
    }

    function shuffleInPlace(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ====== 초기 시드(최소 24개 보장) & 초기 포커스 ======
    window.addEventListener('load', async () => {
      try {
        const MIN = 24;
        const cur = await cheerDB.countAll();
        if (cur < MIN) {
          const need = MIN - cur;
          const sampleMessages = [
            ['응원단장', '힘내세요! 항상 응원하고 있어요!'],
            ['열정맨', '포기하지 마세요! 끝까지 화이팅!'],
            ['희망이', '당신은 충분히 잘하고 있어요!'],
            ['용기쌤', '어려운 시기지만 반드시 극복할 거예요!'],
            ['긍정왕', '오늘도 좋은 하루 되세요!'],
            ['드림캐처', '꿈을 향해 달려가세요!'],
            ['파워업', '당신의 잠재력을 믿어요!'],
            ['선샤인', '밝은 미래가 기다리고 있어요!'],
            ['스트롱', '어떤 어려움도 이겨낼 수 있어요!'],
            ['해피', '행복한 순간들이 가득하길!'],
            ['브레이브', '용감하게 도전하세요!'],
            ['스마일', '웃음 잃지 마세요!'],
            ['위너', '당신은 이미 승리자예요!'],
            ['에너지', '긍정 에너지 가득 보내드려요!'],
            ['별빛', '어둠 속에서도 빛나는 별처럼!'],
            ['바람', '순풍이 불어주길 바라요!'],
            ['무지개', '비 온 뒤 무지개가 뜰 거예요!'],
            ['나침반', '올바른 길로 인도해드릴게요!'],
            ['봄날', '따뜻한 봄날이 올 거예요!'],
            ['날개', '높이 날아오르세요!'],
            ['등대', '길을 잃지 않도록 응원해요!'],
            ['보석', '당신은 소중한 보석 같은 존재!'],
            ['태양', '밝게 빛나는 태양처럼!'],
            ['달빛', '고요한 밤에도 빛을 잃지 마세요!'],
            ['하트', '진심 어린 마음으로 응원합니다!']
          ];
          await cheerDB.seedSamples(sampleMessages.slice(0, need));
          console.log(`[seed] 샘플 ${need}개 주입 완료`);
        }
      } catch (e) {
        console.warn('[seed] 실패:', e);
      }
      document.getElementById('nickname')?.focus();
    });

    // ====== 정적 요소 이벤트 바인딩 ======
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('finalButton')?.addEventListener('click', goToFinalPage);
      document.getElementById('nickname')?.addEventListener('keypress', e => {
        if (e.key === 'Enter') document.getElementById('message')?.focus();
      });
    });
  </script>
</body>
</html>

